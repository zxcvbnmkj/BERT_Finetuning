# å¾®è°ƒ BERT æ¨¡å‹ç”¨äºäºŒåˆ†ç±»ä»»åŠ¡
## Start
å‡†å¤‡ç¯å¢ƒï¼Œå¹¶ä½¿ç”¨ PDM åˆå§‹åŒ–é¡¹ç›®
```
conda create -n bert python=3.10
conda activate bert
pdm init
```
å¯é€‰ï¼šæŸ¥çœ‹å½“å‰ç¯å¢ƒä¸­å­˜åœ¨çš„åŒ…ã€‚ä½¿ç”¨ pdm ä¸ pip å¾—åˆ°çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚è¯´æ˜äºŒè€…å®‰è£…åŒºé—´æ˜¯å…±äº«çš„
```
(bert)  ğŸ bert î‚° ~/BERT_Finetuning î‚° î‚  master Â± î‚° pdm list
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ name       â”‚ version â”‚ location                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pip        â”‚ 25.2    â”‚ /home/conda/feedstock_root/build_artifacts/pip_1753924886980/work â”‚
â”‚ setuptools â”‚ 80.9.0  â”‚                                                                   â”‚
â”‚ wheel      â”‚ 0.45.1  â”‚                                                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```
```
(bert)  ğŸ bert î‚° ~/BERT_Finetuning î‚° î‚  master Â± î‚° pip list               
Package    Version
---------- -------
pip        25.2
setuptools 80.9.0
wheel      0.45.1
```
ä½¿ç”¨ pip ä¸‹è½½ pytorch çš„ CPU ç‰ˆæœ¬ï¼ŒPDM ä¼šä¸‹è½½ gpu ç‰ˆæœ¬çš„ã€‚å› ä¸ºæ¯ä¸ªè®¾å¤‡ä¸åŒï¼Œæ‰€ä»¥ torch æ²¡å¿…è¦ä½¿ç”¨ `pdm.lock` æ¥åŒæ­¥
```
pip install torch
```
ç»™ PDM é…ç½®é•œåƒæº
```
pdm config pypi.url https://mirrors.aliyun.com/pypi/simple/
```
é€šè¿‡ PDM å®‰è£…å…¶ä½™ä¾èµ–
```
pdm sync
```
ç”±äºæœ¬é¡¹ç›®åŸºäº intel CPU çš„ MAC ç³»ç»Ÿç¼–å†™ï¼Œå—é™äºæ“ä½œç³»ç»Ÿæœ€é«˜ä»…å¯ä»¥ä½¿ç”¨ `pytorch 2.2.2`ï¼Œä¸ºäº†å’Œå®ƒé…å¥—ï¼Œå®‰è£…äº† `transformers==4.43.0` å’Œ `numpy==1.24.3` å®ƒä»¬éƒ½å±äºæ—§ç‰ˆæœ¬
## æ–‡ä»¶è¯´æ˜
- `data` æ–‡ä»¶å¤¹ä¸‹é¢å­˜æ”¾ è®­ç»ƒã€éªŒè¯ã€æµ‹è¯•é›†ï¼Œåˆ†åˆ«å‘½åä¸º `trainset` ã€`validset`ã€`testset `ï¼Œå¯ä»¥æ˜¯ `csv `ä¸ `json` ä¸¤ç§æ ¼å¼
- `main.py` : è®­ç»ƒä»£ç 
- `test_code.py` : åœ¨æœ‰æ ‡ç­¾çš„æµ‹è¯•é›†ä¸Šæµ‹è¯•æ¨¡å‹æ€§èƒ½
- `infer.py` : åœ¨æ— æ ‡ç­¾æ•°æ®ä¸Šè¿›è¡Œæ¨ç†å¹¶ä¿å­˜æ­£è´Ÿæ ·æœ¬çš„é¢„æµ‹æ¦‚ç‡å’Œæœ€ç»ˆé¢„æµ‹ç»“æœ
## æ–°å¢æ”¹è¿›
- [X] åˆ©ç”¨ PDM ç®¡ç†ç¯å¢ƒï¼Œåšåˆ°ä¸€é”®å®‰è£…ç¯å¢ƒ
- [X] å…¼å®¹ csv ã€json å¤šç§æ ¼å¼æ•°æ®
- [X] æ¨ç†æ—¶ä»…éœ€åŠ è½½å¾®è°ƒåæ¨¡å‹
## å¾…æ”¹è¿›
1. ã€å·²å®Œæˆã€‘å­˜å‚¨å¾®è°ƒåæ¨¡å‹æ—¶ï¼Œä½¿ç”¨ `model.save_pretrained()` å‡½æ•°å­˜å‚¨å¾®è°ƒæ¨¡å‹ï¼Œæ­¤æ—¶é™¤äº† `BertTokenizer` ä»¥å¤–çš„å…¶ä½™éƒ¨åˆ†éƒ½ä¼šè¢«å­˜å‚¨ï¼Œæ–‡ä»¶å¤§å°ä¸å®Œæ•´ `BERT` æ–‡ä»¶å·®ä¸å¤šã€‚æ¥ä¸‹æ¥éœ€è¦ç ”ç©¶æ˜¯å¦åœ¨å¾®è°ƒéƒ¨åˆ†èƒ½é¿å…å­˜å‚¨æ•´ä¸ª `BERT`ï¼›æˆ–è€…æŠŠ `BertTokenizer` éƒ¨åˆ†ä¹Ÿå­˜åœ¨å¾®è°ƒæ¨¡å‹é‡Œï¼Œè¿™æ ·å°±ä¸éœ€è¦åŠ è½½ `é¢„è®­ç»ƒ BERT`ã€‚
## å…³äºå­˜å‚¨æ–¹æ³•
1. save_pretrained åªä¼šä¿æŒæ¨¡å‹æœ¬èº«ï¼Œä¸ä¿å­˜åˆ†è¯å™¨ã€‚è‹¥éœ€è¦åˆ†è¯å™¨ï¼Œè¿˜è¦é¢å¤–ä¿å­˜ `tokenizer.save_pretrained`
ä½†å…¶å®å¾®è°ƒæ˜¯ä¸ä¼šæ”¹å˜åˆ†è¯å™¨çš„
```
if hasattr(model, 'module'):
    model.module.save_pretrained(f'{dir_name}/bert_classifier')
else:
    model.save_pretrained(f'{dir_name}/bert_classifier')
tokenizer.save_pretrained(f'{dir_name}/bert_classifier')
```
å¾®è°ƒåæ¨¡å‹æœ¬èº«åªä¼šæœ‰ï¼š`model.safetensors` å’Œ `config.json` ä¸¤ä¸ªæ–‡ä»¶
å¦‚æœæŠŠåˆ†è¯å™¨ä¹Ÿä¿å­˜çš„è¯åˆ™æœ‰ï¼š`special_tokens_map.json`ã€`tokenizer_config.json`ã€`vocab.txt` ä¸‰ä¸ªæ–‡ä»¶
## å…³äºä¸€ä¸ªè­¦å‘Š
```
Some weights of BertForSequenceClassification were not initialized from the model checkpoint at /Users/nowcoder/workspace/bert_classification/chinese-bert-wwm and are newly initialized: ['classifier.bias', 'classifier.weight']
You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
æ„æ€æ˜¯ï¼š
BertForSequenceClassification çš„ä¸€äº›æƒé‡æ²¡æœ‰ä»æ¨¡å‹æ£€æŸ¥ç‚¹ /Users/nowcoder/workspace/bert_classification/chinese-bert-wwm åˆå§‹åŒ–ï¼Œè€Œæ˜¯è¢«æ–°åˆå§‹åŒ–çš„ï¼š['classifier.bias', 'classifier.weight']
ä½ å¯èƒ½éœ€è¦åœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸Šè®­ç»ƒè¿™ä¸ªæ¨¡å‹ï¼Œæ‰èƒ½å°†å…¶ç”¨äºé¢„æµ‹å’Œæ¨ç†ã€‚
```
å› ä¸º BertForSequenceClassification åœ¨ BERT çš„åŸºç¡€ä¸Šæ–°åŠ äº†ä¸€ä¸ªå±‚ï¼Œè¿™äº›å±‚ä¸èƒ½ä»é¢„è®­ç»ƒBERT ä¸­è·å–æƒé‡ï¼Œæ‰€ä»¥å¿…é¡»å¾®è°ƒ